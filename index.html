<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医心方数字文献库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "SimSun", "宋体", serif;
        }
        
        body {
            background-color: #f8f6f2;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.03"><rect fill="%23000" width="100" height="100"/></svg>');
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: 1px solid #e8e4dc;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #c8b99c;
        }
        
        .header-title {
            font-size: 2.5rem;
            color: #8a3324;
            margin-bottom: 10px;
            font-weight: normal;
            letter-spacing: 2px;
        }
        
        .header-subtitle {
            font-size: 1rem;
            color: #7a6a52;
            font-style: italic;
        }
        
        .nav {
            margin-bottom: 30px;
        }
        
        .nav-list {
            display: flex;
            justify-content: center;
            list-style: none;
            flex-wrap: wrap;
            border-bottom: 1px solid #e8e4dc;
        }
        
        .nav-item {
            margin: 0 5px;
        }
        
        .nav-link {
            display: block;
            padding: 10px 20px;
            color: #7a6a52;
            text-decoration: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #8a3324;
            border-bottom: 3px solid #8a3324;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* 统计卡片样式 */
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: #f3efe8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
            border: 1px solid #e8e4dc;
        }
        
        .stat-number {
            font-size: 2rem;
            color: #8a3324;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7a6a52;
            font-size: 0.9rem;
        }
        
        /* 搜索框样式 */
        .search-section {
            background: #f9f7f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #e8e4dc;
        }
        
        .search-box {
            padding: 12px 20px;
            width: 70%;
            max-width: 500px;
            border: 1px solid #d6cfc0;
            border-radius: 4px;
            font-size: 1rem;
            margin: 15px 10px;
            outline: none;
            transition: border 0.3s;
        }
        
        .search-box:focus {
            border-color: #8a3324;
        }
        
        .btn {
            padding: 12px 25px;
            background: #8a3324;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #6d281c;
        }
        
        /* 卷目网格样式 */
        .volume-card {
            background: #f9f7f3;   /* 卡片背景 */
            border: none;           /* 去掉边框 */
            border-radius: 8px;     /* 保留圆角 */
            padding: 20px;          /* 内边距 */
            cursor: pointer;        /* 鼠标悬停显示手型 */
            transition: transform 0.3s, box-shadow 0.3s; /* 保留动画 */
        }
        
        .volume-card:hover {
            transform: translateY(-2px); /* 悬停轻微上浮 */
            box-shadow: none;             /* 去掉阴影 */
        }
        
        .volume-number {
            display: inline-block;
            background: #8a3324;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;     /* 字体更小 */
            margin-bottom: 10px;
        }
        
        .volume-title {
            font-size: 1rem;       /* 字体更小 */
            color: #8a3324;
            margin-bottom: 10px;
        }
        
        .volume-description {
            color: #7a6a52;
            font-size: 0.85rem;    /* 字体更小 */
            line-height: 1.5;
        }
        
        /* 卷详情样式 */
        #volume-detail {
            display: none;
            margin-top: 30px;
        }
        
        .back-btn {
            background: #7a6a52;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #635945;
        }
        
        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .page-card {
            background: white;
            border: 1px solid #e8e4dc;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-card:hover {
            border-color: #8a3324;
            box-shadow: 0 5px 15px rgba(138, 51, 36, 0.1);
        }
        
        .page-number {
            display: block;
            font-size: 1.2rem;
            color: #8a3324;
            margin-bottom: 8px;
        }
        
        .page-preview {
            height: 120px;
            background: #f3efe8;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7a6a52;
            font-size: 2rem;
            overflow: hidden;
            position: relative;
        }

        /* PDF查看器样式 */
        .pdf-viewer-container {
            display: none;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #e8e4dc;
            border-radius: 8px;
            background: #f9f7f3;
            padding: 20px;
        }
        
        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8e4dc;
        }
        
        .viewer-title {
            font-size: 1.2rem;
            color: #8a3324;
        }
        
        .viewer-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .viewer-btn {
            padding: 8px 12px;
            background: #7a6a52;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .viewer-btn:hover {
            background: #635945;
        }
        
        .pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .page-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d6cfc0;
            border-radius: 4px;
            text-align: center;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
        
        .control-btn {
            background: #7a6a52;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #635945;
        }
        
        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 1rem;
            color: #7a6a52;
        }
        
        /* iframe 样式 */
        .pdf-iframe {
            width: 100%;
            height: 70vh;
            border: 1px solid #e8e4dc;
            border-radius: 4px;
            background: white;
        }
        
        /* 查看器主体 */
        .viewer-body {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
            gap: 16px;
            align-items: start;
        }
        .canvas-pane { 
            min-width: 0;
            position: relative;
        }
        .text-pane {
            background: #fff;
            border: 1px solid #e8e4dc;
            border-radius: 6px;
            padding: 12px;
            max-height: 70vh;
            overflow: auto;
            position: sticky;
            top: 12px;
        }
        .text-pane .text-pane-title {
            font-size: 1rem;
            color: #8a3324;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .text-pane-tools {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .text-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d6cfc0;
            border-radius: 4px;
            font-size: 0.95rem;
            outline: none;
        }
        .btn-mini {
            background: #8a3324;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-mini:hover { background: #6d281c; }
        .page-text { color: #4b463d; line-height: 1.85; white-space: pre-wrap; word-break: break-word; }
        .page-text mark { background: #ffef74; padding: 0 2px; border-radius: 2px; }
        
        /* 加载遮罩 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 4px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a3324;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .volume-grid {
                grid-template-columns: 1fr;
            }
            .pages-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            .search-box {
                width: 100%;
                margin: 15px 0;
            }
            .viewer-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .viewer-controls {
                width: 100%;
                justify-content: space-between;
            }
            .viewer-body {
                grid-template-columns: 1fr;
            }
            .text-pane { 
                position: static; 
                max-height: none; 
            }
        }

        /* 搜索结果卡片 */
        .entry-card {
            background: #f9f7f3;
            border: 1px solid #e8e4dc;
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
        }
        .entry-title { font-size: 1rem; color: #8a3324; margin-bottom: 6px; }
        .entry-preview { color: #635945; margin: 6px 0; }
        .entry-meta { color: #7a6a52; font-size: 0.85rem; display: flex; gap: 12px; flex-wrap: wrap; }
        .entry-actions { margin-top: 8px; }
        .btn-link { background: #8a3324; color: white; padding: 6px 10px; border-radius: 4px; display: inline-block; cursor: pointer; border: none; }
        .btn-link:hover { background: #6d281c; }
        
        /* 图片查看器样式 */
        .image-viewer {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        
        .image-container {
            max-width: 100%;
            overflow: auto;
            margin-bottom: 15px;
        }
        
        .viewer-image {
            max-width: 100%;
            height: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e8e4dc;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="header-title">医心方数字文献库</h1>
            <p class="header-subtitle">现存最古日本医学典籍 · 数字化研究平台</p>
        </header>
        
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="home" onclick="showSection('home')">首页</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="browse" onclick="showSection('browse')">浏览全书</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="search" onclick="showSection('search')">文本搜索</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="about" onclick="showSection('about')">关于项目</a>
                </li>
            </ul>
        </nav>
        
        <main class="main-content">
            <!-- 首页 -->
            <section id="home" class="content-section active">
                <div class="search-section">
                    <h2>快速检索</h2>
                    <input id="quick-search-input" type="text" class="search-box" placeholder="输入关键词搜索《医心方》全文...">
                    <button class="btn" onclick="performSearch()">搜索</button>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">30</div>
                        <div class="stat-label">卷数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">2000+</div>
                        <div class="stat-label">条文数量</div>
                    </div>
                </div>
                
                <h2>项目简介</h2>
                <p style="line-height: 1.8; color: #555; margin-top: 15px;">
                    《医心方》是现存最古的日本医学典籍，由丹波康赖于公元984年编撰完成。全书30卷，收录了大量中国古代医学文献的精华内容，包括《千金方》、《外台秘要》、《诸病源候论》等重要医籍的条文。本数字化平台旨在为研究者提供便捷的检索和浏览工具，推进古代医学文献的研究与传承。
                </p>
            </section>
            
            <!-- 浏览全书 -->
            <section id="browse" class="content-section">
                <h2>《医心方》卷目浏览</h2>
                <div class="volume-grid">
                    <!-- 30卷内容 -->
                    <div class="volume-card" onclick="showVolume(1)">
                        <span class="volume-number">第1卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(2)">
                        <span class="volume-number">第2卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(3)">
                        <span class="volume-number">第3卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(4)">
                        <span class="volume-number">第4卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(5)">
                        <span class="volume-number">第5卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(6)">
                        <span class="volume-number">第6卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(7)">
                        <span class="volume-number">第7卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(8)">
                        <span class="volume-number">第8卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(9)">
                        <span class="volume-number">第9卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(10)">
                        <span class="volume-number">第10卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(11)">
                        <span class="volume-number">第11卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(12)">
                        <span class="volume-number">第12卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(13)">
                        <span class="volume-number">第13卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(14)">
                        <span class="volume-number">第14卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(15)">
                        <span class="volume-number">第15卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(16)">
                        <span class="volume-number">第16卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(17)">
                        <span class="volume-number">第17卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(18)">
                        <span class="volume-number">第18卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(19)">
                        <span class="volume-number">第19卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(20)">
                        <span class="volume-number">第20卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(21)">
                        <span class="volume-number">第21卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(22)">
                        <span class="volume-number">第22卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(23)">
                        <span class="volume-number">第23卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(24)">
                        <span class="volume-number">第24卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(25)">
                        <span class="volume-number">第25卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(26)">
                        <span class="volume-number">第26卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(27)">
                        <span class="volume-number">第27卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(28)">
                        <span class="volume-number">第28卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(29)">
                        <span class="volume-number">第29卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(30)">
                        <span class="volume-number">第30卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷三十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                </div>
                
                <div id="volume-detail">
                    <!-- 卷详情内容由 JS 动态生成 -->
                </div>
                
                <!-- PDF查看器 -->
                <div class="pdf-viewer-container" id="pdf-viewer">
                    <div class="viewer-header">
                        <div class="viewer-title" id="viewer-title">PDF预览</div>
                        <div class="viewer-controls">
                            <button class="viewer-btn" onclick="downloadCurrentPDF()">
                                <i class="fas fa-download"></i> 打开/下载PDF
                            </button>
                            <button class="viewer-btn" onclick="openViewerInNewTab()">
                                <i class="fas fa-external-link-alt"></i> 在新标签中打开
                            </button>
                            <button class="viewer-btn" onclick="backToPages()">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                    
                    <div class="pdf-controls">
                        <div class="page-navigation">
                            <button class="control-btn" id="prev-btn" onclick="prevPage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            
                            <div class="page-input-group">
                                <input type="number" id="page-input" class="page-input" min="1">
                                <span class="page-info"> / <span id="page-count">?</span></span>
                            </div>
                            
                            <button class="control-btn" id="next-btn" onclick="nextPage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="zoom-controls">
                            <button class="control-btn" onclick="zoomOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="control-btn" onclick="zoomIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="control-btn" onclick="fitWidth()">
                                <i class="fas fa-arrows-alt-h"></i>
                            </button>
                            <button class="control-btn" onclick="fitPage()">
                                <i class="fas fa-arrows-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 查看器主体 -->
                    <div class="viewer-body">
                        <div class="canvas-pane">
                            <!-- 加载遮罩 -->
                            <div class="loading-overlay" id="pdf-loading">
                                <div class="loader-spinner"></div>
                            </div>
                            <!-- PDF iframe -->
                            <iframe id="pdf-iframe" class="pdf-iframe" src="" frameborder="0"></iframe>
                        </div>
                        <aside class="text-pane">
                            <div class="text-pane-title">
                                <span>第<span id="current-page-text">1</span>页文本</span>
                                <button class="btn-mini" id="copy-page-text" title="复制文本">复制</button>
                            </div>
                            <div class="text-pane-tools">
                                <input id="page-text-search" class="text-input" type="text" placeholder="在本页文本内查找">
                            </div>
                            <div id="page-text" class="page-text">暂无文本</div>
                        </aside>
                    </div>
                </div>
                
                <!-- 图片查看器（作为PDF备用） -->
                <div class="image-viewer" id="image-viewer">
                    <div class="viewer-header">
                        <div class="viewer-title" id="image-viewer-title">图片预览</div>
                        <div class="viewer-controls">
                            <button class="viewer-btn" onclick="downloadCurrentImage()">
                                <i class="fas fa-download"></i> 下载图片
                            </button>
                            <button class="viewer-btn" onclick="backToPages()">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                    
                    <div class="image-container">
                        <img id="viewer-image" class="viewer-image" src="" alt="页面图片">
                    </div>
                    
                    <div class="pdf-controls">
                        <div class="page-navigation">
                            <button class="control-btn" id="image-prev-btn" onclick="prevImagePage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            
                            <div class="page-input-group">
                                <input type="number" id="image-page-input" class="page-input" min="1">
                                <span class="page-info"> / <span id="image-page-count">?</span></span>
                            </div>
                            
                            <button class="control-btn" id="image-next-btn" onclick="nextImagePage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="zoom-controls">
                            <button class="control-btn" onclick="zoomImageOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="control-btn" onclick="zoomImageIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="control-btn" onclick="resetImageZoom()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <aside class="text-pane">
                        <div class="text-pane-title">
                            <span>第<span id="current-image-page-text">1</span>页文本</span>
                            <button class="btn-mini" id="copy-image-page-text" title="复制文本">复制</button>
                        </div>
                        <div class="text-pane-tools">
                            <input id="image-page-text-search" class="text-input" type="text" placeholder="在本页文本内查找">
                        </div>
                        <div id="image-page-text" class="page-text">暂无文本</div>
                    </aside>
                </div>
            </section>
            
            <!-- 搜索页面 -->
            <section id="search" class="content-section">
                <div class="search-section">
                    <h2>全文检索</h2>
                    <input type="text" class="search-box" id="search-input" placeholder="输入关键词搜索...">
                    <div class="search-filters" style="margin-top:10px; display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
                        <div class="filter-group">
                            <input type="checkbox" id="filter-exact">
                            <label for="filter-exact">精确匹配</label>
                        </div>
                        <div class="filter-group">
                            <input type="checkbox" id="filter-prescription">
                            <label for="filter-prescription">仅搜索方剂</label>
                        </div>
                        <div class="filter-group">
                            <select id="search-volume-filter">
                                <option value="">所有卷目</option>
                                <option value="1">第1卷</option>
                                <option value="2">第2卷</option>
                                <option value="3">第3卷</option>
                                <!-- 可继续补充 -->
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="performDetailedSearch()" style="margin-top:10px;">搜索</button>
                </div>
                <div id="search-results"></div>
            </section>
            
            <!-- 关于项目 -->
            <section id="about" class="content-section">
                <h2>关于本项目</h2>
                <div style="line-height: 1.8; color: #555;">
                    <h3>项目目标</h3>
                    <p>本项目致力于将《医心方》进行全面数字化整理，为古代医学文献研究提供现代化的检索和浏览平台。</p>
                    
                    <h3 style="margin-top: 30px;">技术特点</h3>
                    <ul style="margin: 15px 0; padding-left: 25px;">
                        <li>纯静态网站，访问速度快</li>
                        <li>响应式设计，支持移动端</li>
                        <li>全文检索功能</li>
                        <li>分类浏览系统</li>
                        <li>PDF和图片双模式查看器，适应不同资源类型</li>
                    </ul>
                    
                    <h3 style="margin-top: 30px;">使用说明</h3>
                    <p>您可以通过导航栏切换不同功能模块，使用搜索功能查找特定内容，或按卷目浏览完整文献。平台同时支持PDF和图片查看，确保在不同环境下都能正常显示文献内容。</p>
                    
                    <h3 style="margin-top: 30px; color: #c0392b;">关于PDF加载问题</h3>
                    <p>如果PDF无法在浏览器中加载，可能是CORS（跨源资源共享）策略导致的。本平台提供了图片查看器作为备选方案，确保文献内容可以正常显示。</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 卷标题和描述
        const volumeTitles = {};
        const volumeDescriptions = {};
        for (let i = 1; i <= 30; i++) {
            const cnNum = ['一','二','三','四','五','六','七','八','九','十',
                          '十一','十二','十三','十四','十五','十六','十七','十八','十九','二十',
                          '二十一','二十二','二十三','二十四','二十五','二十六','二十七','二十八','二十九','三十'][i-1];
            volumeTitles[i] = `医心方 丹波康赖撰 卷${cnNum}`;
            volumeDescriptions[i] = `医心方 丹波康赖撰 卷${cnNum} 总三十卷 十二世纪抄本 东京国立博物馆藏`;
        }

        // 数据
        let volumePages = {};
        let pageTexts = {};
        let pageMeta = {};
        let searchIndex = [];
        
        // 状态
        let currentVolume = 0;
        let currentPage = 1;
        let totalPages = 1;
        let currentPDFUrl = '';
        let currentImageUrl = '';
        let currentZoom = 'auto';
        let imageZoom = 1;
        let isLoading = false;
        let lastSearchQuery = "";
        let currentPageTextRaw = "";
        let currentVolumePages = [];

        // PDF.js viewer 基础URL（使用Mozilla的在线版本或自己部署的版本）
        const viewerBase = 'https://mozilla.github.io/pdf.js/web/viewer.html';
        // 如果你部署了自己的PDF.js viewer，改为：
        // const viewerBase = '/pdfjs/web/viewer.html';

        // 工具函数
        function escapeRegExp(s) {
            return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function escapeHTML(s) {
            if (typeof s !== 'string') return s;
            return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }
        
        function highlightMatches(text, query, exact) {
            if (!query) return text;
            const tokens = exact ? [query] : query.trim().split(/\s+/).filter(Boolean);
            if (!tokens.length) return text;
            const pattern = tokens.map(t => escapeRegExp(t)).join("|");
            const re = new RegExp(pattern, "gi");
            return text.replace(re, m => `<mark>${m}</mark>`);
        }
        
        function getSnippet(text, query, exact, radius = 40) {
            if (!text) return '';
            if (!query) return escapeHTML(text.slice(0, 100)) + (text.length > 100 ? "…" : "");
            const tokens = exact ? [query] : query.trim().split(/\s+/).filter(Boolean);
            if (!tokens.length) return escapeHTML(text.slice(0, 100)) + (text.length > 100 ? "…" : "");
            const pattern = tokens.map(t => escapeRegExp(t)).join("|");
            const re = new RegExp(pattern, "i");
            const m = re.exec(text);
            if (!m) return escapeHTML(text.slice(0, 100)) + (text.length > 100 ? "…" : "");
            const idx = m.index;
            const len = m[0].length;
            const start = Math.max(0, idx - radius);
            const end = Math.min(text.length, idx + len + radius);
            let snippet = text.slice(start, end);
            if (start > 0) snippet = "…" + snippet;
            if (end < text.length) snippet += "…";
            return highlightMatches(escapeHTML(snippet), query, exact);
        }

        // 构建搜索索引
        function buildSearchIndex() {
            searchIndex = [];
            for (const vol in pageTexts) {
                if (!Object.prototype.hasOwnProperty.call(pageTexts, vol)) continue;
                for (const pg in pageTexts[vol]) {
                    if (!Object.prototype.hasOwnProperty.call(pageTexts[vol], pg)) continue;
                    searchIndex.push({
                        volume: Number(vol),
                        page: Number(pg),
                        text: pageTexts[vol][pg] || "",
                        tags: (pageMeta[vol] && pageMeta[vol][pg] && pageMeta[vol][pg].tags) || []
                    });
                }
            }
        }

        // 页面切换
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            const sec = document.getElementById(sectionName);
            if (sec) sec.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            const link = document.querySelector(`.nav-link[data-section="${sectionName}"]`);
            if (link) link.classList.add('active');

            if (sectionName !== 'browse') {
                document.getElementById('volume-detail').style.display = 'none';
                document.getElementById('pdf-viewer').style.display = 'none';
                document.getElementById('image-viewer').style.display = 'none';
                document.querySelector('.volume-grid').style.display = 'grid';
            }
        }

        // 显示卷详情
        function showVolume(volumeNumber) {
            currentVolume = volumeNumber;
            const volumeDetail = document.getElementById('volume-detail');
            const volumeGrid = document.querySelector('.volume-grid');
            
            volumeGrid.style.display = 'none';
            volumeDetail.style.display = 'block';

            const pages = volumePages[volumeNumber] || [];
            currentVolumePages = pages;
            
            volumeDetail.innerHTML = `
                <button class="btn back-btn" onclick="backToVolumeList()">返回卷目列表</button>
                <h2>第${volumeNumber}卷 - ${volumeTitles[volumeNumber] || ""}</h2>
                <p>${volumeDescriptions[volumeNumber] || ""}</p>
                <h3 style="margin-top: 20px;">页面列表</h3>
                <div class="pages-grid">
                    ${pages.map(page => `
                        <div class="page-card" data-volume="${volumeNumber}" data-page="${page.number}" 
                             data-pdf="${encodeURIComponent(page.pdfUrl || '')}" 
                             data-image="${encodeURIComponent(page.imageUrl || '')}">
                            <span class="page-number">第 ${page.number} 页</span>
                            <div class="page-preview">${page.description || ""}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            // 绑定点击事件
            const pageCards = volumeDetail.querySelectorAll('.page-card');
            pageCards.forEach(card => {
                card.addEventListener('click', function() {
                    const vol = Number(this.dataset.volume);
                    const pg = Number(this.dataset.page);
                    const pdf = decodeURIComponent(this.dataset.pdf || '');
                    const image = decodeURIComponent(this.dataset.image || '');
                    
                    // 优先尝试PDF，如果PDF不可用则使用图片
                    if (pdf) {
                        viewPDF(vol, pg, pdf);
                    } else if (image) {
                        viewImage(vol, pg, image);
                    } else {
                        alert('该页面暂无可用资源');
                    }
                });
            });
        }

        function backToVolumeList() {
            document.getElementById('volume-detail').style.display = 'none';
            document.getElementById('pdf-viewer').style.display = 'none';
            document.getElementById('image-viewer').style.display = 'none';
            document.querySelector('.volume-grid').style.display = 'grid';
        }
        
        function backToPages() {
            document.getElementById('pdf-viewer').style.display = 'none';
            document.getElementById('image-viewer').style.display = 'none';
            document.getElementById('volume-detail').style.display = 'block';
        }

        // 打开PDF（初始化）
        function viewPDF(volumeNumber, pageNumber, pdfUrl) {
            currentVolume = volumeNumber;
            currentPage = pageNumber;
            currentPDFUrl = pdfUrl;
            
            // 计算总页数
            totalPages = currentVolumePages.length;
            
            document.getElementById('volume-detail').style.display = 'none';
            document.getElementById('image-viewer').style.display = 'none';
            const pdfViewer = document.getElementById('pdf-viewer');
            pdfViewer.style.display = 'block';
            
            document.getElementById('viewer-title').textContent = `第${volumeNumber}卷 - PDF预览`;
            document.getElementById('page-count').textContent = totalPages;
            
            // 加载指定页
            loadPDFPage(currentPage);
            
            // 更新页面输入框
            const pageInput = document.getElementById('page-input');
            pageInput.value = currentPage;
            pageInput.max = totalPages;
            
            // 更新按钮状态
            updateNavigationButtons();
        }

        // 加载PDF页面（单页）
        function loadPDFPage(pageNum) {
            if (isLoading) return;
            
            isLoading = true;
            const loadingOverlay = document.getElementById('pdf-loading');
            loadingOverlay.classList.add('active');
            
            currentPage = pageNum;
            
            // 更新iframe的src，只加载指定页
            const iframe = document.getElementById('pdf-iframe');
            const viewerUrl = `${viewerBase}?file=${encodeURIComponent(currentPDFUrl)}#page=${pageNum}&zoom=${currentZoom}`;
            
            // 监听iframe加载完成
            iframe.onload = function() {
                isLoading = false;
                loadingOverlay.classList.remove('active');
                
                // 更新文本显示
                showPageText(currentVolume, currentPage, lastSearchQuery);
                
                // 更新页码显示
                document.getElementById('page-input').value = currentPage;
                document.getElementById('current-page-text').textContent = currentPage;
                
                // 更新按钮状态
                updateNavigationButtons();
            };
            
            iframe.onerror = function() {
                isLoading = false;
                loadingOverlay.classList.remove('active');
                console.error('PDF加载失败，尝试使用图片模式');
                
                // 尝试查找对应的图片URL
                const currentPageInfo = currentVolumePages.find(p => p.number === currentPage);
                if (currentPageInfo && currentPageInfo.imageUrl) {
                    viewImage(currentVolume, currentPage, currentPageInfo.imageUrl);
                } else {
                    alert('PDF加载失败，请检查文件路径或CORS设置');
                }
            };
            
            iframe.src = viewerUrl;
        }

        // 打开图片查看器
        function viewImage(volumeNumber, pageNumber, imageUrl) {
            currentVolume = volumeNumber;
            currentPage = pageNumber;
            currentImageUrl = imageUrl;
            
            // 计算总页数
            totalPages = currentVolumePages.length;
            
            document.getElementById('volume-detail').style.display = 'none';
            document.getElementById('pdf-viewer').style.display = 'none';
            const imageViewer = document.getElementById('image-viewer');
            imageViewer.style.display = 'block';
            
            document.getElementById('image-viewer-title').textContent = `第${volumeNumber}卷 - 图片预览`;
            document.getElementById('image-page-count').textContent = totalPages;
            
            // 加载图片
            loadImagePage(currentPage);
            
            // 更新页面输入框
            const pageInput = document.getElementById('image-page-input');
            pageInput.value = currentPage;
            pageInput.max = totalPages;
            
            // 更新按钮状态
            updateImageNavigationButtons();
            
            // 重置缩放
            imageZoom = 1;
            updateImageZoom();
        }

        // 加载图片页面
        function loadImagePage(pageNum) {
            currentPage = pageNum;
            
            // 查找当前页面的图片URL
            const currentPageInfo = currentVolumePages.find(p => p.number === currentPage);
            if (!currentPageInfo) return;
            
            const imageUrl = currentPageInfo.imageUrl || currentPageInfo.pdfUrl?.replace('.pdf', '.jpg');
            if (!imageUrl) return;
            
            const img = document.getElementById('viewer-image');
            img.src = imageUrl;
            img.onload = function() {
                // 更新文本显示
                showImagePageText(currentVolume, currentPage, lastSearchQuery);
                
                // 更新页码显示
                document.getElementById('image-page-input').value = currentPage;
                document.getElementById('current-image-page-text').textContent = currentPage;
                
                // 更新按钮状态
                updateImageNavigationButtons();
            };
            
            img.onerror = function() {
                console.error('图片加载失败');
                alert('图片加载失败，请检查文件路径');
            };
        }

        // 更新导航按钮状态
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }
        
        function updateImageNavigationButtons() {
            const prevBtn = document.getElementById('image-prev-btn');
            const nextBtn = document.getElementById('image-next-btn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        // 翻页功能
        function prevPage() {
            if (currentPage > 1 && !isLoading) {
                // 查找上一页的信息
                const prevPageInfo = currentVolumePages.find(p => p.number === currentPage - 1);
                if (prevPageInfo && prevPageInfo.pdfUrl) {
                    viewPDF(currentVolume, currentPage - 1, prevPageInfo.pdfUrl);
                }
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages && !isLoading) {
                // 查找下一页的信息
                const nextPageInfo = currentVolumePages.find(p => p.number === currentPage + 1);
                if (nextPageInfo && nextPageInfo.pdfUrl) {
                    viewPDF(currentVolume, currentPage + 1, nextPageInfo.pdfUrl);
                }
            }
        }
        
        function prevImagePage() {
            if (currentPage > 1) {
                // 查找上一页的信息
                const prevPageInfo = currentVolumePages.find(p => p.number === currentPage - 1);
                if (prevPageInfo && (prevPageInfo.imageUrl || prevPageInfo.pdfUrl)) {
                    const imageUrl = prevPageInfo.imageUrl || prevPageInfo.pdfUrl.replace('.pdf', '.jpg');
                    viewImage(currentVolume, currentPage - 1, imageUrl);
                }
            }
        }
        
        function nextImagePage() {
            if (currentPage < totalPages) {
                // 查找下一页的信息
                const nextPageInfo = currentVolumePages.find(p => p.number === currentPage + 1);
                if (nextPageInfo && (nextPageInfo.imageUrl || nextPageInfo.pdfUrl)) {
                    const imageUrl = nextPageInfo.imageUrl || nextPageInfo.pdfUrl.replace('.pdf', '.jpg');
                    viewImage(currentVolume, currentPage + 1, imageUrl);
                }
            }
        }
        
        // 跳转到指定页
        function goToPage(pageNum) {
            pageNum = parseInt(pageNum);
            if (pageNum >= 1 && pageNum <= totalPages && pageNum !== currentPage && !isLoading) {
                // 查找指定页的信息
                const pageInfo = currentVolumePages.find(p => p.number === pageNum);
                if (pageInfo && pageInfo.pdfUrl) {
                    viewPDF(currentVolume, pageNum, pageInfo.pdfUrl);
                }
            }
        }
        
        function goToImagePage(pageNum) {
            pageNum = parseInt(pageNum);
            if (pageNum >= 1 && pageNum <= totalPages && pageNum !== currentPage) {
                // 查找指定页的信息
                const pageInfo = currentVolumePages.find(p => p.number === pageNum);
                if (pageInfo && (pageInfo.imageUrl || pageInfo.pdfUrl)) {
                    const imageUrl = pageInfo.imageUrl || pageInfo.pdfUrl.replace('.pdf', '.jpg');
                    viewImage(currentVolume, pageNum, imageUrl);
                }
            }
        }

        // 缩放功能
        function zoomIn() {
            currentZoom = 'in';
            updateZoom();
        }
        
        function zoomOut() {
            currentZoom = 'out';
            updateZoom();
        }
        
        function fitWidth() {
            currentZoom = 'page-width';
            updateZoom();
        }
        
        function fitPage() {
            currentZoom = 'page-fit';
            updateZoom();
        }
        
        function updateZoom() {
            // 重新加载当前页面，应用新的缩放设置
            loadPDFPage(currentPage);
        }
        
        function zoomImageIn() {
            imageZoom += 0.2;
            updateImageZoom();
        }
        
        function zoomImageOut() {
            imageZoom = Math.max(0.2, imageZoom - 0.2);
            updateImageZoom();
        }
        
        function resetImageZoom() {
            imageZoom = 1;
            updateImageZoom();
        }
        
        function updateImageZoom() {
            const img = document.getElementById('viewer-image');
            img.style.transform = `scale(${imageZoom})`;
            img.style.transformOrigin = 'top left';
        }

        // 在新标签页打开
        function openViewerInNewTab() {
            if (!currentPDFUrl) {
                alert('当前没有打开的PDF');
                return;
            }
            const url = `${viewerBase}?file=${encodeURIComponent(currentPDFUrl)}#page=${currentPage}&zoom=${currentZoom}`;
            window.open(url, '_blank');
        }

        // 下载PDF
        function downloadCurrentPDF() {
            if (!currentPDFUrl) {
                alert('没有可下载的PDF');
                return;
            }
            window.open(currentPDFUrl, '_blank');
        }
        
        // 下载图片
        function downloadCurrentImage() {
            if (!currentImageUrl) {
                alert('没有可下载的图片');
                return;
            }
            window.open(currentImageUrl, '_blank');
        }

        // 显示页面文本
        function showPageText(volume, page, highlightQuery = "") {
            const raw = (pageTexts[volume] && pageTexts[volume][page]) || "暂无文本";
            currentPageTextRaw = raw;
            const html = highlightQuery ? highlightMatches(escapeHTML(raw), highlightQuery, false) : escapeHTML(raw);
            document.getElementById('page-text').innerHTML = html;
            document.getElementById('page-text-search').value = highlightQuery || "";
        }
        
        function showImagePageText(volume, page, highlightQuery = "") {
            const raw = (pageTexts[volume] && pageTexts[volume][page]) || "暂无文本";
            currentPageTextRaw = raw;
            const html = highlightQuery ? highlightMatches(escapeHTML(raw), highlightQuery, false) : escapeHTML(raw);
            document.getElementById('image-page-text').innerHTML = html;
            document.getElementById('image-page-text-search').value = highlightQuery || "";
        }
        
        // 文本搜索高亮
        function updatePageTextHighlightFromInput() {
            const q = document.getElementById('page-text-search').value.trim();
            const html = q ? highlightMatches(escapeHTML(currentPageTextRaw), q, false) : escapeHTML(currentPageTextRaw);
            document.getElementById('page-text').innerHTML = html;
        }
        
        function updateImagePageTextHighlightFromInput() {
            const q = document.getElementById('image-page-text-search').value.trim();
            const html = q ? highlightMatches(escapeHTML(currentPageTextRaw), q, false) : escapeHTML(currentPageTextRaw);
            document.getElementById('image-page-text').innerHTML = html;
        }

        // 复制文本
        function copyPageText() {
            if (!currentPageTextRaw) return;
            navigator.clipboard?.writeText(currentPageTextRaw).then(() => {
                const btn = document.getElementById('copy-page-text');
                const old = btn.textContent;
                btn.textContent = '已复制';
                setTimeout(() => btn.textContent = old, 1200);
            }).catch(() => alert('复制失败'));
        }
        
        function copyImagePageText() {
            if (!currentPageTextRaw) return;
            navigator.clipboard?.writeText(currentPageTextRaw).then(() => {
                const btn = document.getElementById('copy-image-page-text');
                const old = btn.textContent;
                btn.textContent = '已复制';
                setTimeout(() => btn.textContent = old, 1200);
            }).catch(() => alert('复制失败'));
        }

        // 获取PDF URL
        function getPdfUrl(volume, page) {
            const arr = volumePages[volume] || [];
            const item = arr.find(p => p.number === page);
            return item ? item.pdfUrl : '';
        }

        // 打开搜索结果
        function openResult(volume, page, query) {
            lastSearchQuery = query || "";
            showSection('browse');
            showVolume(volume);
            const url = getPdfUrl(volume, page);
            if (url) {
                viewPDF(volume, page, url);
            } else {
                // 尝试使用图片
                const arr = volumePages[volume] || [];
                const item = arr.find(p => p.number === page);
                if (item && item.imageUrl) {
                    viewImage(volume, page, item.imageUrl);
                } else {
                    alert('未找到该页的资源地址。');
                }
            }
        }

        // 快速搜索
        function performSearch() {
            const query = document.getElementById('quick-search-input').value || "";
            if (!query.trim()) return;
            showSection('search');
            document.getElementById('search-input').value = query.trim();
            performDetailedSearch();
        }

        // 详细搜索
        function performDetailedSearch() {
            const input = document.getElementById('search-input');
            const query = (input.value || "").trim();
            const exact = !!document.getElementById('filter-exact').checked;
            const onlyPres = !!document.getElementById('filter-prescription').checked;
            const volFilter = document.getElementById('search-volume-filter').value;
            const resultsDiv = document.getElementById('search-results');

            if (!query) {
                resultsDiv.innerHTML = '<p>请输入搜索关键词</p>';
                return;
            }

            const tokens = exact ? [query] : query.split(/\s+/).filter(Boolean);
            const matchOne = (text) => {
                if (!text) return false;
                const lowerText = text.toLowerCase();
                if (exact) return lowerText.includes(query.toLowerCase());
                return tokens.every(t => lowerText.includes(t.toLowerCase()));
            };

            let results = searchIndex.filter(r => {
                if (volFilter && String(r.volume) !== volFilter) return false;
                if (onlyPres && !(r.tags || []).includes("方剂")) return false;
                return matchOne(r.text);
            });

            if (!results.length) {
                resultsDiv.innerHTML = `<p>未找到与"${escapeHTML(query)}"相关的结果。</p>`;
                return;
            }

            const html = [
                `<h3>搜索结果（${results.length} 条）</h3>`,
                ...results.map(r => {
                    const snippet = getSnippet(r.text, query, exact, 50);
                    return `
                        <div class="entry-card">
                            <div class="entry-title">卷 ${r.volume} · 第 ${r.page} 页</div>
                            <div class="entry-preview">${snippet}</div>
                            <div class="entry-meta">
                                <span>分类：${(r.tags && r.tags.length) ? r.tags.join('、') : '—'}</span>
                            </div>
                            <div class="entry-actions">
                                <button class="btn-link" onclick="openResult(${r.volume}, ${r.page}, '${(query || '').replace(/'/g, "\\'")}')">打开此页</button>
                            </div>
                        </div>
                    `;
                })
            ].join('');
            resultsDiv.innerHTML = html;
        }

        // 事件绑定
        document.addEventListener('DOMContentLoaded', () => {
            // 页面文本搜索
            const pageTextInput = document.getElementById('page-text-search');
            if (pageTextInput) {
                pageTextInput.addEventListener('input', updatePageTextHighlightFromInput);
            }
            
            const imagePageTextInput = document.getElementById('image-page-text-search');
            if (imagePageTextInput) {
                imagePageTextInput.addEventListener('input', updateImagePageTextHighlightFromInput);
            }
            
            // 复制按钮
            const copyBtn = document.getElementById('copy-page-text');
            if (copyBtn) {
                copyBtn.addEventListener('click', copyPageText);
            }
            
            const copyImageBtn = document.getElementById('copy-image-page-text');
            if (copyImageBtn) {
                copyImageBtn.addEventListener('click', copyImagePageText);
            }
            
            // 页码输入框
            const pageInput = document.getElementById('page-input');
            if (pageInput) {
                pageInput.addEventListener('change', function() {
                    goToPage(this.value);
                });
                
                pageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        goToPage(this.value);
                    }
                });
            }
            
            const imagePageInput = document.getElementById('image-page-input');
            if (imagePageInput) {
                imagePageInput.addEventListener('change', function() {
                    goToImagePage(this.value);
                });
                
                imagePageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        goToImagePage(this.value);
                    }
                });
            }
        });

        // 加载数据
        fetch('./volume-content.json')
            .then(response => response.json())
            .then(data => {
                volumePages = data.volumePages || {};
                pageTexts = data.pageTexts || {};
                pageMeta = data.pageMeta || {};
                buildSearchIndex();
            })
            .catch(err => {
                console.warn('无法加载 JSON 数据:', err);
                // 示例数据
                volumePages = {
                    1: [
                        { number: 1, pdfUrl: './samples/vol1-page1.pdf', imageUrl: './samples/vol1-page1.jpg', description: '示例：卷1 第1页' },
                        { number: 2, pdfUrl: './samples/vol1-page2.pdf', imageUrl: './samples/vol1-page2.jpg', description: '示例：卷1 第2页' },
                        { number: 3, pdfUrl: './samples/vol1-page3.pdf', imageUrl: './samples/vol1-page3.jpg', description: '示例：卷1 第3页' }
                    ]
                };
                pageTexts = {
                    1: {
                        1: '这是卷1第1页的示例文本内容。',
                        2: '这是卷1第2页的示例文本内容。',
                        3: '这是卷1第3页的示例文本内容。'
                    }
                };
                pageMeta = {};
                buildSearchIndex();
            });
    </script>
</body>
</html>
