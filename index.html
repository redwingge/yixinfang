
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医心方数字文献库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "SimSun", "宋体", serif;
        }
        
        body {
            background-color: #f8f6f2;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.03"><rect fill="%23000" width="100" height="100"/></svg>');
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border: 1px solid #e8e4dc;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #c8b99c;
        }
        
        .header-title {
            font-size: 2.5rem;
            color: #8a3324;
            margin-bottom: 10px;
            font-weight: normal;
            letter-spacing: 2px;
        }
        
        .header-subtitle {
            font-size: 1rem;
            color: #7a6a52;
            font-style: italic;
        }
        
        .nav {
            margin-bottom: 30px;
        }
        
        .nav-list {
            display: flex;
            justify-content: center;
            list-style: none;
            flex-wrap: wrap;
            border-bottom: 1px solid #e8e4dc;
        }
        
        .nav-item {
            margin: 0 5px;
        }
        
        .nav-link {
            display: block;
            padding: 10px 20px;
            color: #7a6a52;
            text-decoration: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #8a3324;
            border-bottom: 3px solid #8a3324;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* 统计卡片样式 */
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: #f3efe8;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
            border: 1px solid #e8e4dc;
        }
        
        .stat-number {
            font-size: 2rem;
            color: #8a3324;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7a6a52;
            font-size: 0.9rem;
        }
        
        /* 搜索框样式 */
        .search-section {
            background: #f9f7f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #e8e4dc;
        }
        
        .search-box {
            padding: 12px 20px;
            width: 70%;
            max-width: 500px;
            border: 1px solid #d6cfc0;
            border-radius: 4px;
            font-size: 1rem;
            margin: 15px 10px;
            outline: none;
            transition: border 0.3s;
        }
        
        .search-box:focus {
            border-color: #8a3324;
        }
        
        .btn {
            padding: 12px 25px;
            background: #8a3324;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #6d281c;
        }
        
        /* 卷目网格样式 */
        .volume-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .volume-card {
            background: #f9f7f3;
            border: 1px solid #e8e4dc;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .volume-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .volume-number {
            display: inline-block;
            background: #8a3324;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .volume-title {
            font-size: 1.2rem;
            color: #8a3324;
            margin-bottom: 10px;
        }
        
        .volume-description {
            color: #7a6a52;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* 卷详情样式 */
        #volume-detail {
            display: none;
            margin-top: 30px;
        }
        
        .back-btn {
            background: #7a6a52;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #635945;
        }
        
        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .page-card {
            background: white;
            border: 1px solid #e8e4dc;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-card:hover {
            border-color: #8a3324;
            box-shadow: 0 5px 15px rgba(138, 51, 36, 0.1);
        }
        
        .page-number {
            display: block;
            font-size: 1.2rem;
            color: #8a3324;
            margin-bottom: 8px;
        }
        
        .page-preview {
            height: 120px;
            background: #f3efe8;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7a6a52;
            font-size: 2rem;
            overflow: hidden;
            position: relative;
        }
        .page-preview .thumb-skeleton {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #f3efe8 0%, #ede9e0 50%, #f3efe8 100%);
            background-size: 200% 100%;
            animation: shimmer 1.2s linear infinite;
        }
        .page-preview img.page-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 4px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* PDF查看器样式 */
        .pdf-viewer-container {
            display: none;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #e8e4dc;
            border-radius: 8px;
            background: #f9f7f3;
            padding: 20px;
        }
        
        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8e4dc;
        }
        
        .viewer-title {
            font-size: 1.2rem;
            color: #8a3324;
        }
        
        .viewer-controls {
            display: flex;
            gap: 10px;
        }
        
        .viewer-btn {
            padding: 8px 15px;
            background: #7a6a52;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .viewer-btn:hover {
            background: #635945;
        }
        
        .pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .page-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
        
        .control-btn {
            background: #7a6a52;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #635945;
        }
        
        .page-info {
            font-size: 1rem;
            color: #7a6a52;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 70vh;
            border: 1px solid #e8e4dc;
            border-radius: 4px;
            background: white;
        }
        
        /* 查看器主体：PDF画布 + 文本侧栏 */
        .viewer-body {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
            gap: 16px;
            align-items: start;
        }
        .canvas-pane { min-width: 0; }
        .text-pane {
            background: #fff;
            border: 1px solid #e8e4dc;
            border-radius: 6px;
            padding: 12px;
            max-height: 70vh;
            overflow: auto;
            position: sticky;
            top: 12px;
        }
        .text-pane .text-pane-title {
            font-size: 1rem;
            color: #8a3324;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .text-pane-tools {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .text-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d6cfc0;
            border-radius: 4px;
            font-size: 0.95rem;
            outline: none;
        }
        .btn-mini {
            background: #8a3324;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-mini:hover { background: #6d281c; }
        .page-text { color: #4b463d; line-height: 1.85; white-space: pre-wrap; word-break: break-word; }
        .page-text mark { background: #ffef74; padding: 0 2px; border-radius: 2px; }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .volume-grid {
                grid-template-columns: 1fr;
            }
            .pages-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            .search-box {
                width: 100%;
                margin: 15px 0;
            }
            .viewer-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .viewer-controls {
                width: 100%;
                justify-content: space-between;
            }
            .viewer-body {
                grid-template-columns: 1fr;
            }
            .text-pane { position: static; max-height: none; }
        }
        
        /* PDF.js 画布样式 */
        .pdf-viewer canvas {
            margin: 0 auto;
            display: block;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background: #fff;
        }
        
        /* 加载指示器 */
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a3324;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 搜索结果卡片（美化你原来的占位） */
        .entry-card {
            background: #f9f7f3;
            border: 1px solid #e8e4dc;
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
        }
        .entry-title { font-size: 1rem; color: #8a3324; margin-bottom: 6px; }
        .entry-preview { color: #635945; margin: 6px 0; }
        .entry-meta { color: #7a6a52; font-size: 0.85rem; display: flex; gap: 12px; flex-wrap: wrap; }
        .entry-actions { margin-top: 8px; }
        .btn-link { background: #8a3324; color: white; padding: 6px 10px; border-radius: 4px; display: inline-block; cursor: pointer; border: none; }
        .btn-link:hover { background: #6d281c; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="header-title">医心方数字文献库</h1>
            <p class="header-subtitle">现存最古日本医学典籍 · 数字化研究平台</p>
        </header>
        
        <nav class="nav">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-section="home" onclick="showSection('home')">首页</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="browse" onclick="showSection('browse')">浏览全书</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="search" onclick="showSection('search')">文本搜索</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-section="about" onclick="showSection('about')">关于项目</a>
                </li>
            </ul>
        </nav>
        
        <main class="main-content">
            <!-- 首页 -->
            <section id="home" class="content-section active">
                <div class="search-section">
                    <h2>快速检索</h2>
                    <input id="quick-search-input" type="text" class="search-box" placeholder="输入关键词搜索《医心方》全文...">
                    <button class="btn" onclick="performSearch()">搜索</button>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">30</div>
                        <div class="stat-label">卷数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">2000+</div>
                        <div class="stat-label">条文数量</div>
                    </div>
                </div>
                
                <h2>项目简介</h2>
                <p style="line-height: 1.8; color: #555; margin-top: 15px;">
                    《医心方》是现存最古的日本医学典籍，由丹波康赖于公元984年编撰完成。全书30卷，收录了大量中国古代医学文献的精华内容，包括《千金方》、《外台秘要》、《诸病源候论》等重要医籍的条文。本数字化平台旨在为研究者提供便捷的检索和浏览工具，推进古代医学文献的研究与传承。
                </p>
            </section>
            
            <!-- 浏览全书 -->
            <section id="browse" class="content-section">
                <h2>《医心方》卷目浏览</h2>
                <div class="volume-grid">
                    <div class="volume-card" onclick="showVolume(1)">
                        <span class="volume-number">第1卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(2)">
                        <span class="volume-number">第2卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(3)">
                        <span class="volume-number">第3卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(4)">
                        <span class="volume-number">第4卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(5)">
                        <span class="volume-number">第5卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(6)">
                        <span class="volume-number">第6卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(7)">
                        <span class="volume-number">第7卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(8)">
                        <span class="volume-number">第8卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(9)">
                        <span class="volume-number">第9卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(10)">
                        <span class="volume-number">第10卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(11)">
                        <span class="volume-number">第11卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(12)">
                        <span class="volume-number">第12卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(13)">
                        <span class="volume-number">第13卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(14)">
                        <span class="volume-number">第14卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(15)">
                        <span class="volume-number">第15卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(16)">
                        <span class="volume-number">第16卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(17)">
                        <span class="volume-number">第17卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(18)">
                        <span class="volume-number">第18卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(19)">
                        <span class="volume-number">第19卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷十九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(20)">
                        <span class="volume-number">第20卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(21)">
                        <span class="volume-number">第21卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十一 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(22)">
                        <span class="volume-number">第22卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十二 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(23)">
                        <span class="volume-number">第23卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十三 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(24)">
                        <span class="volume-number">第24卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十四 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(25)">
                        <span class="volume-number">第25卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十五 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(26)">
                        <span class="volume-number">第26卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十六 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(27)">
                        <span class="volume-number">第27卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十七 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(28)">
                        <span class="volume-number">第28卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十八 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(29)">
                        <span class="volume-number">第29卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷二十九 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                    <div class="volume-card" onclick="showVolume(30)">
                        <span class="volume-number">第30卷</span>
                        <div class="volume-title">医心方 丹波康赖撰</div>
                        <div class="volume-description">医心方 丹波康赖撰 卷三十 总三十卷 十二世纪抄本 东京国立博物馆藏</div>
                    </div>
                </div>
                
                <div id="volume-detail">
                    <!-- 卷详情内容由 JS 动态生成 -->
                </div>
                
                <div class="pdf-viewer-container" id="pdf-viewer">
                    <div class="viewer-header">
                        <div class="viewer-title" id="viewer-title">PDF预览</div>
                        <div class="viewer-controls">
                            <button class="viewer-btn" onclick="downloadCurrentPDF()">
                                <i class="fas fa-download"></i> 下载PDF
                            </button>
                            <button class="viewer-btn" onclick="backToPages()">
                                <i class="fas fa-arrow-left"></i> 返回
                            </button>
                        </div>
                    </div>
                    
                    <div class="pdf-controls">
                        <div class="page-navigation">
                            <button class="control-btn" onclick="prevPage()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="page-info">
                                页码: <span id="page-num">1</span> / <span id="page-count">1</span>
                            </span>
                            <button class="control-btn" onclick="nextPage()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="zoom-controls">
                            <button class="control-btn" onclick="zoomOut()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="control-btn" onclick="zoomIn()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="control-btn" onclick="fitWidth()">
                                <i class="fas fa-arrows-alt-h"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 新增：查看器主体 两栏布局 -->
                    <div class="viewer-body">
                        <div class="canvas-pane">
                            <div class="pdf-viewer" id="pdf-canvas-container">
                                <div class="loader" id="pdf-loader">
                                    <div class="loader-spinner"></div>
                                </div>
                                <canvas id="pdf-canvas"></canvas>
                            </div>
                        </div>
                        <aside class="text-pane">
                            <div class="text-pane-title">
                                <span>对应页文本</span>
                                <button class="btn-mini" id="copy-page-text" title="复制文本">复制</button>
                            </div>
                            <div class="text-pane-tools">
                                <input id="page-text-search" class="text-input" type="text" placeholder="在本页文本内查找（回车或输入即高亮）">
                            </div>
                            <div id="page-text" class="page-text">暂无文本</div>
                        </aside>
                    </div>
                </div>
            </section>
            
            <!-- 搜索页面 -->
            <section id="search" class="content-section">
                <div class="search-section">
                    <h2>全文检索</h2>
                    <input type="text" class="search-box" id="search-input" placeholder="输入关键词搜索...">
                    <div class="search-filters" style="margin-top:10px; display:flex; gap:16px; justify-content:center; flex-wrap:wrap;">
                        <div class="filter-group">
                            <input type="checkbox" id="filter-exact">
                            <label for="filter-exact">精确匹配</label>
                        </div>
                        <div class="filter-group">
                            <input type="checkbox" id="filter-prescription">
                            <label for="filter-prescription">仅搜索方剂</label>
                        </div>
                        <div class="filter-group">
                            <select id="search-volume-filter">
                                <option value="">所有卷目</option>
                                <option value="1">第1卷</option>
                                <option value="2">第2卷</option>
                                <option value="3">第3卷</option>
                                <option value="19">第19卷</option>
                                <!-- 可继续补充 -->
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="performDetailedSearch()" style="margin-top:10px;">搜索</button>
                </div>
                <div id="search-results"></div>
            </section>
            
            <!-- 关于项目 -->
            <section id="about" class="content-section">
                <h2>关于本项目</h2>
                <div style="line-height: 1.8; color: #555;">
                    <h3>项目目标</h3>
                    <p>本项目致力于将《医心方》进行全面数字化整理，为古代医学文献研究提供现代化的检索和浏览平台。</p>
                    
                    <h3 style="margin-top: 30px;">技术特点</h3>
                    <ul style="margin: 15px 0; padding-left: 25px;">
                        <li>纯静态网站，访问速度快</li>
                        <li>响应式设计，支持移动端</li>
                        <li>全文检索功能</li>
                        <li>分类浏览系统</li>
                        <li>PDF.js集成，支持浏览器内PDF查看</li>
                    </ul>
                    
                    <h3 style="margin-top: 30px;">使用说明</h3>
                    <p>您可以通过导航栏切换不同功能模块，使用搜索功能查找特定内容，或按卷目浏览完整文献。在浏览全书时，可以查看每卷的页面列表并使用PDF.js查看器浏览PDF内容。</p>
                    
                    <h3 style="margin-top: 30px; color: #c0392b;">关于PDF加载问题</h3>
                    <p>如果PDF无法在浏览器中加载，但可以下载，这通常是 CORS（跨源资源共享）策略导致的。服务器需要配置 Access-Control-Allow-Origin 响应头，以允许此网页访问PDF资源。</p>
                </div>
            </section>
        </main>
    </div>

    <!-- 引入PDF.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
                // 标题与描述（保持你原来的）
        const volumeTitles = {
            1: "医心方 丹波康赖撰 卷一",
            2: "医心方 丹波康赖撰 卷二",
            3: "医心方 丹波康赖撰 卷三",
            4: "医心方 丹波康赖撰 卷四",
            5: "医心方 丹波康赖撰 卷五",
            6: "医心方 丹波康赖撰 卷六",
            7: "医心方 丹波康赖撰 卷七",
            8: "医心方 丹波康赖撰 卷八",
            9: "医心方 丹波康赖撰 卷九",
            10: "医心方 丹波康赖撰 卷十",
            11: "医心方 丹波康赖撰 卷十一",
            12: "医心方 丹波康赖撰 卷十二",
            13: "医心方 丹波康赖撰 卷十三",
            14: "医心方 丹波康赖撰 卷十四",
            15: "医心方 丹波康赖撰 卷十五",
            16: "医心方 丹波康赖撰 卷十六",
            17: "医心方 丹波康赖撰 卷十七",
            18: "医心方 丹波康赖撰 卷十八",
            19: "医心方 丹波康赖撰 卷十九",
            20: "医心方 丹波康赖撰 卷二十",
            21: "医心方 丹波康赖撰 卷二十一",
            22: "医心方 丹波康赖撰 卷二十二",
            23: "医心方 丹波康赖撰 卷二十三",
            24: "医心方 丹波康赖撰 卷二十四",
            25: "医心方 丹波康赖撰 卷二十五",
            26: "医心方 丹波康赖撰 卷二十六",
            27: "医心方 丹波康赖撰 卷二十七",
            28: "医心方 丹波康赖撰 卷二十八",
            29: "医心方 丹波康赖撰 卷二十九",
            30: "医心方 丹波康赖撰 卷三十",
        };
        const volumeDescriptions = {
            1: "医心方 丹波康赖撰 卷一 总三十卷 十二世纪抄本 东京国立博物馆藏",
            2: "医心方 丹波康赖撰 卷二 总三十卷 十二世纪抄本 东京国立博物馆藏",
            3: "医心方 丹波康赖撰 卷三 总三十卷 十二世纪抄本 东京国立博物馆藏",
            4: "医心方 丹波康赖撰 卷四 总三十卷 十二世纪抄本 东京国立博物馆藏",
            5: "医心方 丹波康赖撰 卷五 总三十卷 十二世纪抄本 东京国立博物馆藏",
            6: "医心方 丹波康赖撰 卷六 总三十卷 十二世纪抄本 东京国立博物馆藏",
            7: "医心方 丹波康赖撰 卷七 总三十卷 十二世纪抄本 东京国立博物馆藏",
            8: "医心方 丹波康赖撰 卷八 总三十卷 十二世纪抄本 东京国立博物馆藏",
            9: "医心方 丹波康赖撰 卷九 总三十卷 十二世纪抄本 东京国立博物馆藏",
            10: "医心方 丹波康赖撰 卷十 总三十卷 十二世纪抄本 东京国立博物馆藏",
            11: "医心方 丹波康赖撰 卷十一 总三十卷 十二世纪抄本 东京国立博物馆藏",
            12: "医心方 丹波康赖撰 卷十二 总三十卷 十二世纪抄本 东京国立博物馆藏",
            13: "医心方 丹波康赖撰 卷十三 总三十卷 十二世纪抄本 东京国立博物馆藏",
            14: "医心方 丹波康赖撰 卷十四 总三十卷 十二世纪抄本 东京国立博物馆藏",
            15: "医心方 丹波康赖撰 卷十五 总三十卷 十二世纪抄本 东京国立博物馆藏",
            16: "医心方 丹波康赖撰 卷十六 总三十卷 十二世纪抄本 东京国立博物馆藏",
            17: "医心方 丹波康赖撰 卷十七 总三十卷 十二世纪抄本 东京国立博物馆藏",
            18: "医心方 丹波康赖撰 卷十八 总三十卷 十二世纪抄本 东京国立博物馆藏",
            19: "医心方 丹波康赖撰 卷十九 总三十卷 十二世纪抄本 东京国立博物馆藏",
            20: "医心方 丹波康赖撰 卷二十 总三十卷 十二世纪抄本 东京国立博物馆藏",
            21: "医心方 丹波康赖撰 卷二十一 总三十卷 十二世纪抄本 东京国立博物馆藏",
            22: "医心方 丹波康赖撰 卷二十二 总三十卷 十二世纪抄本 东京国立博物馆藏",
            23: "医心方 丹波康赖撰 卷二十三 总三十卷 十二世纪抄本 东京国立博物馆藏",
            24: "医心方 丹波康赖撰 卷二十四 总三十卷 十二世纪抄本 东京国立博物馆藏",
            25: "医心方 丹波康赖撰 卷二十五 总三十卷 十二世纪抄本 东京国立博物馆藏",
            26: "医心方 丹波康赖撰 卷二十六 总三十卷 十二世纪抄本 东京国立博物馆藏",
            27: "医心方 丹波康赖撰 卷二十七 总三十卷 十二世纪抄本 东京国立博物馆藏",
            28: "医心方 丹波康赖撰 卷二十八 总三十卷 十二世纪抄本 东京国立博物馆藏",
            29: "医心方 丹波康赖撰 卷二十九 总三十卷 十二世纪抄本 东京国立博物馆藏",
            30: "医心方 丹波康赖撰 卷三十 总三十卷 十二世纪抄本 东京国立博物馆藏",
        };
    </script>
    <script>
    let volumePages = {};
    let pageTexts = {};
    let pageMeta = {};
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        

        // 索引（由 pageTexts 构建）
        let searchIndex = [];
        function buildSearchIndex() {
            searchIndex = [];
            for (const vol in pageTexts) {
                for (const pg in pageTexts[vol]) {
                    searchIndex.push({
                        volume: Number(vol),
                        page: Number(pg),
                        text: pageTexts[vol][pg] || "",
                        tags: (pageMeta[vol] && pageMeta[vol][pg] && pageMeta[vol][pg].tags) || []
                    });
                }
            }
        }
        buildSearchIndex();

        // PDF查看器状态
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.5; // 会在 fitWidth 中自适应
        let currentPDFUrl = '';
        let currentVolume = 0;
        let currentPage = 0;
        let lastSearchQuery = ""; // 用于打开页面时高亮
        let currentPageTextRaw = ""; // 当前页文本（原文）

        // 工具：转义与高亮
        function escapeRegExp(s) {
            return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        function highlightMatches(text, query, exact) {
            if (!query) return text;
            const tokens = exact ? [query] : query.trim().split(/\s+/).filter(Boolean);
            if (!tokens.length) return text;
            const pattern = tokens.map(t => escapeRegExp(t)).join("|");
            const re = new RegExp(pattern, "gi");
            return text.replace(re, m => `<mark>${m}</mark>`);
        }
        function getSnippet(text, query, exact, radius = 40) {
            if (!query) return text.slice(0, 100) + (text.length > 100 ? "…" : "");
            const tokens = exact ? [query] : query.trim().split(/\s+/).filter(Boolean);
            if (!tokens.length) return text.slice(0, 100) + (text.length > 100 ? "…" : "");
            const pattern = tokens.map(t => escapeRegExp(t)).join("|");
            const re = new RegExp(pattern, "i");
            const idx = text.search(re);
            if (idx === -1) return text.slice(0, 100) + (text.length > 100 ? "…" : "");
            const start = Math.max(0, idx - radius);
            const end = Math.min(text.length, idx + (exact ? query.length : tokens[0].length) + radius);
            let snippet = text.slice(start, end);
            if (start > 0) snippet = "…" + snippet;
            if (end < text.length) snippet += "…";
            return highlightMatches(snippet, query, exact);
        }

        // 显示指定section（修复了原先对 event 的依赖）
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');

            // 高亮导航
            document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
            const link = document.querySelector(`.nav-link[data-section="${sectionName}"]`);
            if (link) link.classList.add('active');

            // 重置浏览状态
            if (sectionName !== 'browse') {
                document.getElementById('volume-detail').style.display = 'none';
                document.getElementById('pdf-viewer').style.display = 'none';
                document.querySelector('.volume-grid').style.display = 'grid';
            }
        }

        // 显示卷详情（并生成缩略图预览的占位）
        function showVolume(volumeNumber) {
            const volumeDetail = document.getElementById('volume-detail');
            const volumeGrid = document.querySelector('.volume-grid');
            
            volumeGrid.style.display = 'none';
            volumeDetail.style.display = 'block';

            const pages = volumePages[volumeNumber] || [];
            volumeDetail.innerHTML = `
                <button class="btn back-btn" onclick="backToVolumeList()">返回卷目列表</button>
                <h2>第${volumeNumber}卷 - ${volumeTitles[volumeNumber] || ""}</h2>
                <p>${volumeDescriptions[volumeNumber] || ""}</p>
                <h3 style="margin-top: 20px;">页面列表</h3>
                <div class="pages-grid">
                    ${pages.map(page => `
                        <div class="page-card" onclick="viewPDF(${volumeNumber}, ${page.number}, '${page.pdfUrl}')">
                            <div class="page-preview" id="preview-v${volumeNumber}-p${page.number}" data-pdf-url="${page.pdfUrl}">
                                <div class="thumb-skeleton" aria-hidden="true"></div>
                            </div>
                            <span class="page-number">第 ${page.number} 页</span>
                            <div>${page.description || ""}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            initPageThumbnails(volumeNumber);
        }

        // 返回卷目列表
        function backToVolumeList() {
            document.getElementById('volume-detail').style.display = 'none';
            document.getElementById('pdf-viewer').style.display = 'none';
            document.querySelector('.volume-grid').style.display = 'grid';
        }
        
        // 返回页面列表
        function backToPages() {
            document.getElementById('pdf-viewer').style.display = 'none';
            document.getElementById('volume-detail').style.display = 'block';
        }
        
        // 查看PDF + 同步右侧对应文本
        function viewPDF(volumeNumber, pageNumber, pdfUrl) {
            currentVolume = volumeNumber;
            currentPage = pageNumber;
            currentPDFUrl = pdfUrl;
            lastSearchQuery = lastSearchQuery || ""; // 保持上次搜索词用于高亮
            
            document.getElementById('volume-detail').style.display = 'none';
            const pdfViewer = document.getElementById('pdf-viewer');
            pdfViewer.style.display = 'block';
            
            document.getElementById('viewer-title').textContent =
                `第${volumeNumber}卷 - 第${pageNumber}页`;

            // 展示对应页文本侧栏
            showPageText(volumeNumber, pageNumber, lastSearchQuery);

            // 加载PDF
            loadPDF(pdfUrl);
        }

        // 加载PDF（失败时提示 CORS）
        function loadPDF(url) {
            document.getElementById('pdf-loader').style.display = 'flex';
            document.getElementById('pdf-canvas').style.display = 'none';
            document.getElementById('pdf-canvas-container').style.display = 'block';
            document.getElementById('pdf-canvas-container').innerHTML = `
                <div class="loader" id="pdf-loader">
                    <div class="loader-spinner"></div>
                </div>
                <canvas id="pdf-canvas"></canvas>
            `;
            
            pageNum = 1;
            
            pdfjsLib.getDocument(url).promise.then(function(pdf) {
                pdfDoc = pdf;
                document.getElementById('page-count').textContent = pdf.numPages;

                // 先自动适应宽度再渲染
                fitWidth().then(() => renderPage(pageNum)).catch(() => renderPage(pageNum));
            }).catch(function(error) {
                console.error('加载PDF失败:', error);
                const container = document.getElementById('pdf-canvas-container');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #c0392b;">
                        <h3>无法加载PDF</h3>
                        <p>可能是 CORS（跨源资源共享）限制所致。请检查服务器是否返回了 Access-Control-Allow-Origin 响应头。</p>
                        <p>仍可点击右上角“下载PDF”按钮获取文件。</p>
                    </div>
                `;
            });
        }
        
        // 渲染PDF页面（高清优化：按设备像素比绘制）
        function renderPage(num) {
            if (!pdfDoc) return;
            pageRendering = true;

            document.getElementById('pdf-loader').style.display = 'flex';
            const canvas = document.getElementById('pdf-canvas');
            canvas.style.display = 'none';
            const ctx = canvas.getContext('2d');

            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({ scale });

                // 高清 Canvas
                const outputScale = window.devicePixelRatio || 1;
                canvas.style.width = viewport.width + "px";
                canvas.style.height = viewport.height + "px";
                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);

                const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                    transform: transform
                };
                const renderTask = page.render(renderContext);
                
                renderTask.promise.then(function() {
                    pageRendering = false;
                    document.getElementById('page-num').textContent = num;
                    document.getElementById('pdf-loader').style.display = 'none';
                    canvas.style.display = 'block';
                    
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        }
        
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }
        
        function prevPage() {
            if (!pdfDoc || pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }
        
        function nextPage() {
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }
        
        function zoomIn() {
            scale += 0.25;
            queueRenderPage(pageNum);
        }
        
        function zoomOut() {
            if (scale <= 0.5) return;
            scale -= 0.25;
            queueRenderPage(pageNum);
        }
        
        // 自适应宽度（返回 Promise 方便链式调用）
        function fitWidth() {
            return new Promise((resolve, reject) => {
                if (!pdfDoc) return reject();
                const container = document.getElementById('pdf-canvas-container');
                pdfDoc.getPage(pageNum).then(function(page) {
                    const viewport = page.getViewport({ scale: 1 });
                    scale = container.clientWidth / viewport.width;
                    resolve();
                }).catch(reject);
            });
        }
        
        // 下载当前PDF
        function downloadCurrentPDF() {
            const link = document.createElement('a');
            link.href = currentPDFUrl;
            link.download = `医心方_第${currentVolume}卷_第${currentPage}页.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 显示右侧对应页文本 + 高亮
        function showPageText(volume, page, highlightQuery = "") {
            const raw = (pageTexts[volume] && pageTexts[volume][page]) || "暂无文本";
            currentPageTextRaw = raw;
            const exact = true; // 打开页面时，以“原样词”高亮
            const html = highlightMatches(escapeHTML(raw), highlightQuery, exact);
            document.getElementById('page-text').innerHTML = html;
            document.getElementById('page-text-search').value = highlightQuery || "";
        }
        function escapeHTML(s) {
            return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }
        function updatePageTextHighlightFromInput() {
            const q = document.getElementById('page-text-search').value.trim();
            const html = q ? highlightMatches(escapeHTML(currentPageTextRaw), q, false) : escapeHTML(currentPageTextRaw);
            document.getElementById('page-text').innerHTML = html;
        }
        function copyPageText() {
            if (!currentPageTextRaw) return;
            navigator.clipboard?.writeText(currentPageTextRaw).then(() => {
                // 小提示（简单）
                const btn = document.getElementById('copy-page-text');
                const old = btn.textContent;
                btn.textContent = '已复制';
                setTimeout(() => btn.textContent = old, 1200);
            }).catch(() => {});
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('page-text-search').addEventListener('input', updatePageTextHighlightFromInput);
            document.getElementById('copy-page-text').addEventListener('click', copyPageText);
        });

        // 搜索（首页）
        function performSearch() {
            const query = document.getElementById('quick-search-input').value || "";
            if (!query.trim()) return;
            showSection('search');
            document.getElementById('search-input').value = query.trim();
            performDetailedSearch();
        }

        // 仅供获取 url
        function getPdfUrl(volume, page) {
            const arr = volumePages[volume] || [];
            const item = arr.find(p => p.number === page);
            return item ? item.pdfUrl : '';
        }

        // 打开搜索结果
        function openResult(volume, page, query) {
            lastSearchQuery = query || "";
            showSection('browse');
            showVolume(volume);
            const url = getPdfUrl(volume, page);
            if (url) {
                viewPDF(volume, page, url);
            } else {
                alert('未找到该页的PDF地址。');
            }
        }

        // 详细搜索（搜“对应页文本”）
        function performDetailedSearch() {
            const input = document.getElementById('search-input');
            const query = (input.value || "").trim();
            const exact = !!document.getElementById('filter-exact').checked;
            const onlyPres = !!document.getElementById('filter-prescription').checked;
            const volFilter = document.getElementById('search-volume-filter').value;
            const resultsDiv = document.getElementById('search-results');

            if (!query) {
                resultsDiv.innerHTML = '<p>请输入搜索关键词</p>';
                return;
            }

            // 过滤
            const tokens = exact ? [query] : query.split(/\s+/).filter(Boolean);
            const matchOne = (text) => {
                if (exact) return text.includes(query);
                // 所有词都需出现
                return tokens.every(t => text.toLowerCase().includes(t.toLowerCase()));
            };

            let results = searchIndex.filter(r => {
                if (volFilter && String(r.volume) !== volFilter) return false;
                if (onlyPres && !(r.tags || []).includes("方剂")) return false;
                return matchOne(r.text);
            });

            // 排序简单处理：命中位置越前越靠前
            results = results.sort((a, b) => {
                const pa = a.text.toLowerCase().indexOf((exact ? query : tokens[0]).toLowerCase());
                const pb = b.text.toLowerCase().indexOf((exact ? query : tokens[0]).toLowerCase());
                return (pa === -1 ? 1 : pa) - (pb === -1 ? 1 : pb);
            });

            if (!results.length) {
                resultsDiv.innerHTML = `<p>未找到与“${escapeHTML(query)}”相关的结果。</p>`;
                return;
            }

            const html = [
                `<h3>搜索结果（${results.length} 条）</h3>`,
                ...results.map(r => {
                    const snippet = getSnippet(r.text, query, exact, 50);
                    return `
                        <div class="entry-card">
                            <div class="entry-title">卷 ${r.volume} · 第 ${r.page} 页</div>
                            <div class="entry-preview">${snippet}</div>
                            <div class="entry-meta">
                                <span>分类：${(r.tags && r.tags.length) ? r.tags.join('、') : '—'}</span>
                            </div>
                            <div class="entry-actions">
                                <button class="btn-link" onclick="openResult(${r.volume}, ${r.page}, '${query.replace(/'/g, "\\'")}')">打开此页</button>
                            </div>
                        </div>
                    `;
                })
            ].join('');
            resultsDiv.innerHTML = html;
        }

        // 缩略图懒加载
        function initPageThumbnails(volumeNumber) {
            const previews = document.querySelectorAll(`#volume-detail .page-preview[data-pdf-url]`);
            if (!previews.length) return;

            const io = ('IntersectionObserver' in window) ? new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        io.unobserve(el);
                        const url = el.getAttribute('data-pdf-url');
                        loadThumbnail(el, url);
                    }
                });
            }, { rootMargin: '100px' }) : null;

            previews.forEach(el => {
                if (io) io.observe(el);
                else loadThumbnail(el, el.getAttribute('data-pdf-url'));
            });
        }

        async function loadThumbnail(previewEl, pdfUrl) {
            try {
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                const page = await pdf.getPage(1);
                const targetH = previewEl.clientHeight || 120;
                const viewport1 = page.getViewport({ scale: 1 });
                const s = targetH / viewport1.height;
                const viewport = page.getViewport({ scale: s });

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                canvas.width = Math.floor(viewport.width * dpr);
                canvas.height = Math.floor(viewport.height * dpr);
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';

                await page.render({
                    canvasContext: ctx,
                    viewport,
                    transform: dpr !== 1 ? [dpr, 0, 0, dpr, 0, 0] : null
                }).promise;

                const url = canvas.toDataURL('image/png');
                previewEl.innerHTML = `<img class="page-thumb" alt="缩略图" src="${url}">`;
            } catch (e) {
                console.warn('缩略图加载失败（可能CORS）：', e);
                previewEl.innerHTML = `<span style="color:#7a6a52;font-size:14px;">预览不可用</span>`;
            }
        }



    // 加载外部 JSON 数据
    fetch('./volume-content.json')
        .then(response => response.json())
        .then(data => {
            volumePages = data.volumePages || {};
            pageTexts = data.pageTexts || {};
            pageMeta = data.pageMeta || {};

            buildSearchIndex(); // 构建索引
        })
        .catch(err => {
            console.error('无法加载 JSON 数据:', err);
        });
    </script>
</body>
</html>
